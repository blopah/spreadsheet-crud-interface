<script>

// Make query params available in this file
<? for(var key in atts) {?>
    var <?!= key; ?> = <?= atts[key]; ?>;
<? } ?>


function getFormValues(container) {

    var values = [];
    $(container).find('input, select, textarea').each(function() {
        values.push($(this).val());
    });

    return values;

}


function setContent(template, atts, after) {

    var target = '#dynamic-content';
    $(target).empty();
    appendContent(target, template, atts, after);

}


function appendContent(target, template, atts, after) {

    runFunction('templatePart', [template, atts], function(content) {

        $(target).append(content);

        $('select').select2();
        $('.data-table').DataTable();
        if(_.isFunction(after)) after.apply(this);

    });

};


function runFunction(func, args, success) {

    toggleProgress();

    return google.script.run
    .withSuccessHandler(wrap(success, false, toggleProgress))
    .withFailureHandler(wrap(function(error) {
        var title = 'Something went terribly wrong...';
        showModal(title, error.message);
    }, false, toggleProgress))[func].apply(this, args);

}


function toggleProgress() {

    $('.progress').toggle();

}


function showModal(title, message) {

    $('.modal-title').html(title);
    $('.modal-body').html(message);
    $('.modal').modal();

};


function wrap(fn, before, after) {

    return function () {
        if(_.isFunction(before)) before.apply(this, arguments);
        var result = fn.apply(this, arguments);
        if(_.isFunction(after)) after.call(this, result);
        return result;
    };

};

</script>